#"SHOC STARTS HERE"
import std
import fileio
import args
import lex
import grammar
import stdio
import err
import profile

function(cstr err) shoc::bail_out -> void does
	printf("\n\nshoc::bail_out called, orth::fail traceback follows...\n")
	orth::fail(err)
return

function(int nargs, ArgList args) main -> int does
	orth::install_sigsev_handler()
	bool PROFILE=false
	if nargs>2 do 
		PROFILE=args:get(2)=="--profile"
	done

	if PROFILE do
		orth::internal::profile::install_profiler()
	done

	stdio::init()
	if nargs<2 do
		printf("E: Bad args\n")
		return 1
	done

	if args:get(1)=="--show-parser-types" do
		parse::init()
		parse::show_types()
		return 0
	done

	File fd = File::open(args:get(1), "r")
	cstr raw_contents=fd:readall()
	cstr contents=raw_contents+"\n"
	raw_contents:free()
	fd:close()
	fd:free()

	lex::init()
	parse::init()

	printf("Parsing Text: `%s`\n", contents)

	List tokens = lex::tokenize(contents)
	parse::parse(tokens, contents)

	# XXXX Broken
	# Token::free_token_list(tokens)
	# parse::free()
	# lex::free()
	# contents:free()

	if PROFILE do
		orth::internal::profile::dump_profiling_data_csv("profile.csv")
	done
return 0