<html>
	<head>
		<title>../os/kernel/mm.ort</title>
		<link rel="stylesheet" type="text/css" href="syntax.css">
	</head>
	<body>
		<pre>

<span class="orth-T_INTRINSIC">@declare_func(&quot;__kgetcs&quot;, &quot;int&quot;, &quot;()&quot;)@</span><br/><span class="orth-T_INTRINSIC">@declare_func(&quot;__kgetds&quot;, &quot;int&quot;, &quot;()&quot;)@</span><br/><span class="orth-T_INTRINSIC">@declare_func(&quot;__kgetss&quot;, &quot;int&quot;, &quot;()&quot;)@</span><br/><span class="orth-T_INTRINSIC">@declare_func(&quot;__kreloadselectors&quot;, &quot;int&quot;, &quot;()&quot;)@</span><br/><span class="orth-T_INTRINSIC">@declare_func(&quot;__klgdt&quot;, &quot;void&quot;, &quot;(i32)&quot;)@</span><br/><br/><span class="orth-T_VAR_DECL-type">ptr</span> <span class="orth-T_VAR_DECL-name">mm_head</span><br/><span class="orth-T_VAR_DECL-type">ptr</span> <span class="orth-T_VAR_DECL-name">mm_pos</span><br/><span class="orth-T_VAR_DECL-type">ptr</span> <span class="orth-T_VAR_DECL-name">last_alloc</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT-type">int</span> <span class="orth-T_ARGLIST_ELEMENT-name">start</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">KMM::init</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">mm_head</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">start</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">ptr</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">mm_pos</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">mm_head</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">last_alloc</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_INTEGER_LITERAL">0xDEADBEEF</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">ptr</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT-type">int</span> <span class="orth-T_ARGLIST_ELEMENT-name">amt</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">malloc</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">ptr</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">ptr</span> <span class="orth-T_VAR_DECL-name">ret</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">mm_pos</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">mm_pos</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">mm_pos</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">offset</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">amt</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">last_alloc</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">ret</span><br/><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">ret</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT-type">int</span> <span class="orth-T_ARGLIST_ELEMENT-name">to</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">malign</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">mm_pos</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">mm_pos</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">offset</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">to</span><span class="orth-T_BINARY_OPERATOR">-</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">mm_pos</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_BINARY_OPERATOR">%</span><span class="orth-T_NAME">to</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT-type">ptr</span> <span class="orth-T_ARGLIST_ELEMENT-name">idx</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">free</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_LINE_COMMENT">#Haha, jokes on you- you thought I was responsible with memory allocation, nope!</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_IF_START">if</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">last_alloc</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><span class="orth-T_BINARY_OPERATOR">==</span><span class="orth-T_NAME">idx</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">mm_pos</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">last_alloc</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">last_alloc</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_INTEGER_LITERAL">0xDEADBEEF</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">ptr</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT-type">ptr</span> <span class="orth-T_ARGLIST_ELEMENT-name">addr</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT-type">int</span> <span class="orth-T_ARGLIST_ELEMENT-name">len</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT-type">byte</span> <span class="orth-T_ARGLIST_ELEMENT-name">value</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">memset</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">int</span> <span class="orth-T_VAR_DECL-name">idx</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_INTEGER_LITERAL">0</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHILE_START">while</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">idx</span><span class="orth-T_BINARY_OPERATOR">&lt;</span><span class="orth-T_NAME">len</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">addr</span><span class="orth-T_LIST_START">[</span><span class="orth-T_NAME">idx</span><span class="orth-T_LIST_STOP">]</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">value</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">idx</span><span class="orth-T_AUGASSIGN">+=</span><span class="orth-T_INTEGER_LITERAL">1</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT-type">ptr</span> <span class="orth-T_ARGLIST_ELEMENT-name">source</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT-type">ptr</span> <span class="orth-T_ARGLIST_ELEMENT-name">dest</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT-type">int</span> <span class="orth-T_ARGLIST_ELEMENT-name">len</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">memcpy</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">int</span> <span class="orth-T_VAR_DECL-name">idx</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_INTEGER_LITERAL">0</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHILE_START">while</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">idx</span><span class="orth-T_BINARY_OPERATOR">&lt;</span><span class="orth-T_NAME">len</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">dest</span><span class="orth-T_LIST_START">[</span><span class="orth-T_NAME">idx</span><span class="orth-T_LIST_STOP">]</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">source</span><span class="orth-T_LIST_START">[</span><span class="orth-T_NAME">idx</span><span class="orth-T_LIST_STOP">]</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">idx</span><span class="orth-T_AUGASSIGN">+=</span><span class="orth-T_INTEGER_LITERAL">1</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">__i32Box</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_PACKED">packed</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">int</span> <span class="orth-T_VAR_DECL-name">i</span><br/><span class="orth-T_TYPEDECL_END">endtype</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT-type">ptr</span> <span class="orth-T_ARGLIST_ELEMENT-name">source</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT-type">ptr</span> <span class="orth-T_ARGLIST_ELEMENT-name">dest</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT-type">int</span> <span class="orth-T_ARGLIST_ELEMENT-name">len</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">memcpy32</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHILE_START">while</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">len</span><span class="orth-T_BINARY_OPERATOR">&gt;=</span><span class="orth-T_INTEGER_LITERAL">4</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">dest</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">offset</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">len</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">__i32Box</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">i</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">source</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">offset</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">len</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">__i32Box</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">i</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">len</span><span class="orth-T_AUGASSIGN">-=</span><span class="orth-T_INTEGER_LITERAL">4</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT-type">ptr</span> <span class="orth-T_ARGLIST_ELEMENT-name">p</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT-type">int</span> <span class="orth-T_ARGLIST_ELEMENT-name">amt</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">ptr:offset</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">ptr</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">p</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_BINARY_OPERATOR">+</span><span class="orth-T_NAME">amt</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">ptr</span><br/><br/><span class="orth-T_LINE_COMMENT">#GDT Stuff</span><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">GDTEntry</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_PACKED">packed</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">short</span> <span class="orth-T_VAR_DECL-name">limit_low</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">short</span> <span class="orth-T_VAR_DECL-name">base_low</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">byte</span> <span class="orth-T_VAR_DECL-name">base_mid</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">byte</span> <span class="orth-T_VAR_DECL-name">access_flags</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">byte</span> <span class="orth-T_VAR_DECL-name">monstrosity</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_LINE_COMMENT">#bits 0-3 are limit 16:19 (limit high,) and bits 4-7 are flags</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">byte</span> <span class="orth-T_VAR_DECL-name">base_high</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT-type">int</span> <span class="orth-T_ARGLIST_ELEMENT-name">base</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT-type">int</span> <span class="orth-T_ARGLIST_ELEMENT-name">to</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT-type">bool</span> <span class="orth-T_ARGLIST_ELEMENT-name">exec</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT-type">bool</span> <span class="orth-T_ARGLIST_ELEMENT-name">user</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">GDTEntry::new</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">GDTEntry</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">GDTEntry</span> <span class="orth-T_VAR_DECL-name">new</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">malloc</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTRINSIC">@sizeof(GDTEntry)@</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">GDTEntry</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">uint</span> <span class="orth-T_VAR_DECL-name">limit</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">to</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">uint</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_BINARY_OPERATOR">-</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">base</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">uint</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">bool</span> <span class="orth-T_VAR_DECL-name">page_granularity</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">bool</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_IF_START">if</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">limit</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BINARY_OPERATOR">&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0xFFFFF</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">uint</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_LINE_COMMENT">#in this case, can&#x27;t store it as bytes, need to set the granularity flag</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_LINE_COMMENT"># and store in units of 4KiB blocks (pages)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">limit</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">limit</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BINARY_OPERATOR">&gt;&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">12</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_LINE_COMMENT">#convert to units of 4KiB</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">page_granularity</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">1</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">bool</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">limit_low</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">limit</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BINARY_OPERATOR">&amp;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0xFFFF</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">short</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">monstrosity</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">limit</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BINARY_OPERATOR">&gt;&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">16</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BINARY_OPERATOR">&amp;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0xF</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">byte</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">base_low</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">base</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BINARY_OPERATOR">&amp;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0xFFFF</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">short</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">base_mid</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">base</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BINARY_OPERATOR">&gt;&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">16</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BINARY_OPERATOR">&amp;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0xFF</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">byte</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">base_high</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">base</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BINARY_OPERATOR">&gt;&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">24</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BINARY_OPERATOR">&amp;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0xFF</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">byte</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">monstrosity</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_AUGASSIGN">+=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0b01000000</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">byte</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_LINE_COMMENT">#                     ^- 32-bit entry</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">access_flags</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0b10010010</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">byte</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_LINE_COMMENT">#                    ^  ^  ^- Can read code/write data, yes!</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_LINE_COMMENT">#                     \  \- Must be 1</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_LINE_COMMENT">#                      \- Present, yes!</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_IF_START">if</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">user</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">access_flags</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_AUGASSIGN">+=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0b01100000</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">byte</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_LINE_COMMENT">#                      ^^- Set privelage mode to 3 (userland)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_LINE_COMMENT">#Privelage (bits 5:6) already set to 0 for kernel code</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_IF_START">if</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">exec</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">access_flags</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_AUGASSIGN">+=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0b00001000</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">byte</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_LINE_COMMENT">#                         ^- Exec bit - Is code</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_IF_START">if</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">page_granularity</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">monstrosity</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_AUGASSIGN">+=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0b10000000</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">byte</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_LINE_COMMENT">#                    ^- Granularity bit - Limit is in units of 4KiB blocks instead now</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">new</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT-type">GDTEntry</span> <span class="orth-T_ARGLIST_ELEMENT-name">e</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">GDTEntry:print</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">print</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot;GDTEntry&lt;&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">printi</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">e</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">limit_low</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">print</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot;,&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">printi</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">e</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">base_low</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">print</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot;,&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">printi</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">e</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">base_mid</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">print</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot;,&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">printi</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">e</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">access_flags</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">print</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot;,&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">printi</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">e</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">monstrosity</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">print</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot;,&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">printi</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">e</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">base_high</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">printl</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot;&gt;&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><br/><span class="orth-T_TYPEDECL_END">endtype</span><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">GDT</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_PACKED">packed</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">short</span> <span class="orth-T_VAR_DECL-name">size</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">int</span> <span class="orth-T_VAR_DECL-name">pointer</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">int</span> <span class="orth-T_VAR_DECL-name">current_idx</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT-type">int</span> <span class="orth-T_ARGLIST_ELEMENT-name">entries</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">GDT::new</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">GDT</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">malign</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">256</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">GDT</span> <span class="orth-T_VAR_DECL-name">new</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">malloc</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTRINSIC">@sizeof(GDT)@</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">GDT</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">size</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">entries</span><span class="orth-T_BINARY_OPERATOR">+</span><span class="orth-T_INTEGER_LITERAL">1</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_BINARY_OPERATOR">*</span><span class="orth-T_INTRINSIC">@sizeof(GDTEntry)@</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">short</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_LINE_COMMENT">#Include space for null entry</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">malign</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">256</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">pointer</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">malloc</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">size</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">current_idx</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_INTEGER_LITERAL">1</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">memset</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">pointer</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">ptr</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">size</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">byte</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">size</span><span class="orth-T_AUGASSIGN">-=</span><span class="orth-T_INTEGER_LITERAL">1</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">short</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_LINE_COMMENT">#x86 is dumb and wants size-1</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">new</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT-type">GDT</span> <span class="orth-T_ARGLIST_ELEMENT-name">table</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT-type">int</span> <span class="orth-T_ARGLIST_ELEMENT-name">idx</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT-type">GDTEntry</span> <span class="orth-T_ARGLIST_ELEMENT-name">entry</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">GDT:insert</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">int</span> <span class="orth-T_VAR_DECL-name">entry_sz</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_INTRINSIC">@sizeof(GDTEntry)@</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">ptr</span> <span class="orth-T_VAR_DECL-name">target</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">table</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">pointer</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">ptr</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">offset</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">entry_sz</span><span class="orth-T_BINARY_OPERATOR">*</span><span class="orth-T_NAME">idx</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">memcpy</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">entry</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">ptr</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">target</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">entry_sz</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT-type">GDT</span> <span class="orth-T_ARGLIST_ELEMENT-name">table</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT-type">GDTEntry</span> <span class="orth-T_ARGLIST_ELEMENT-name">entry</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">GDT:add</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">table</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">insert</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">table</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">current_idx</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">entry</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">table</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME-accessor">current_idx</span><span class="orth-T_AUGASSIGN">+=</span><span class="orth-T_INTEGER_LITERAL">1</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><br/><span class="orth-T_TYPEDECL_END">endtype</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">install_gdt</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">GDT</span> <span class="orth-T_VAR_DECL-name">gdt</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">GDT</span><span class="orth-T_DOUBLECOLON">::</span><span class="orth-T_NAME-accessor">new</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">2</span><span class="orth-T_PAREN_CLOSE">)</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">GDTEntry</span> <span class="orth-T_VAR_DECL-name">kernel_code</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">GDTEntry</span><span class="orth-T_DOUBLECOLON">::</span><span class="orth-T_NAME-accessor">new</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x0</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0xFFFFFFFF</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">1</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">bool</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">bool</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">gdt</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">add</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">kernel_code</span><span class="orth-T_PAREN_CLOSE">)</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL-type">GDTEntry</span> <span class="orth-T_VAR_DECL-name">kernel_data</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">GDTEntry</span><span class="orth-T_DOUBLECOLON">::</span><span class="orth-T_NAME-accessor">new</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x0</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0xFFFFFFFF</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">bool</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">bool</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">gdt</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">add</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">kernel_data</span><span class="orth-T_PAREN_CLOSE">)</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">print</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot;GDT@&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME-accessor">dumphexi</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">gdt</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">ptr</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">__klgdt</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">gdt</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">ptr</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME-cast-type">int</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_RETURN">return</span><br/><span class="orth-T_WHITESPACE"> </span>

		</pre>
	</body>
</html>