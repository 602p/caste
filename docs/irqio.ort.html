<html>
	<head>
		<title>../os/kernel/irqio.ort</title>
		<link rel="stylesheet" type="text/css" href="syntax.css">
	</head>
	<body>
		<pre>

<span class="orth-T_INTRINSIC">@declare_func(&quot;__kget_internal_irq_table&quot;, &quot;ptr&quot;, &quot;()&quot;)@</span><br/><span class="orth-T_INTRINSIC">@declare_func(&quot;__klidt&quot;, &quot;void&quot;, &quot;(i8*)&quot;)@</span><br/><span class="orth-T_INTRINSIC">@declare_func(&quot;__kwritepb&quot;, &quot;void&quot;, &quot;(i8, i8)&quot;)@</span><br/><span class="orth-T_INTRINSIC">@declare_func(&quot;__kreadpb&quot;, &quot;ubyte&quot;, &quot;(i8)&quot;)@</span><br/><span class="orth-T_IMPORT">import mm</span><br/><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">InternalIDTHandlerLookupTableEntry</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_PACKED">packed</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">int addr</span><br/><span class="orth-T_TYPEDECL_END">endtype</span><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">InternalIDTHandlerLookupTable</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_PACKED">packed</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">int count</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">InternalIDTHandlerLookupTable t</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int idx</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">InternalIDTHandlerLookupTable:get</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">int</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">t</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">ptr</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">offset</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">4</span><span class="orth-T_BINARY_OPERATOR">+</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">4</span><span class="orth-T_BINARY_OPERATOR">*</span><span class="orth-T_NAME">idx</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">InternalIDTHandlerLookupTableEntry</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">addr</span><br/><span class="orth-T_TYPEDECL_END">endtype</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">int p</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int d</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">write_port</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">__kwritepb</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">p</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">byte</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">d</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">byte</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">int p</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">read_port</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">int</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">__kreadpb</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">p</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">byte</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">int</span><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">IRQHandler</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_ALIAS">a</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_FUNCTIONPOINTER">function-&gt;void</span><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">IRQHandlerBox</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_PACKED">packed</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">IRQHandler handler</span><br/><span class="orth-T_TYPEDECL_END">endtype</span><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">IRQHandlerTable</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">int count</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">IRQHandlerTable::new</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">IRQHandlerTable</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">IRQHandlerTable new</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">malloc</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">4</span><span class="orth-T_BINARY_OPERATOR">*</span><span class="orth-T_NAME">count</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">IRQHandlerTable</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">memset</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">new</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">ptr</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">4</span><span class="orth-T_BINARY_OPERATOR">*</span><span class="orth-T_NAME">count</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">byte</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">new</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">IRQHandlerTable t</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int idx</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">IRQHandler handler</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">IRQHandlerTable:set</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">t</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">ptr</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">offset</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">4</span><span class="orth-T_BINARY_OPERATOR">*</span><span class="orth-T_NAME">idx</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">IRQHandlerBox</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">handler</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">handler</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">IRQHandlerTable t</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int idx</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">IRQHandlerTable:get</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">IRQHandler</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">t</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">ptr</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">offset</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">4</span><span class="orth-T_BINARY_OPERATOR">*</span><span class="orth-T_NAME">idx</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">IRQHandlerBox</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">handler</span><br/><span class="orth-T_TYPEDECL_END">endtype</span><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">IDTEntry</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_PACKED">packed</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">short offset_low</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">short selector</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">byte  zero</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">byte  type</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">short offset_high</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">IDTEntry entry</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int irupt_addr</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">IDTEntry:set</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">entry</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">offset_low</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">irupt_addr</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BINARY_OPERATOR">&amp;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0xFFFF</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">short</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">entry</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">selector</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_INTEGER_LITERAL">0x08</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">short</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">entry</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">zero</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">byte</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">entry</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">type</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_INTEGER_LITERAL">0x8E</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">byte</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">entry</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">offset_high</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">irupt_addr</span><span class="orth-T_BINARY_OPERATOR">&amp;</span><span class="orth-T_INTEGER_LITERAL">0xFFFF0000</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BINARY_OPERATOR">&gt;&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">16</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">short</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><br/><span class="orth-T_TYPEDECL_END">endtype</span><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">IDT</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_PACKED">packed</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">short idt_size</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">int idt_address</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">IRQHandlerTable handlers</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">IDT::create</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">IDT</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">IDT new</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">malloc</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTRINSIC">@sizeof(IDT)@</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">IDT</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">idt_size</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTRINSIC">@sizeof(IDTEntry)@</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_BINARY_OPERATOR">*</span><span class="orth-T_INTEGER_LITERAL">256</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_BINARY_OPERATOR">-</span><span class="orth-T_INTEGER_LITERAL">1</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">short</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_LINE_COMMENT">#Said -1</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">idt_address</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">malloc</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">idt_size</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">int</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_BINARY_OPERATOR">+</span><span class="orth-T_INTEGER_LITERAL">1</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">int</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">memset</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">idt_address</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">ptr</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">idt_size</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">int</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_BINARY_OPERATOR">+</span><span class="orth-T_INTEGER_LITERAL">1</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">byte</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">handlers</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">IRQHandlerTable</span><span class="orth-T_DOUBLECOLON">::</span><span class="orth-T_NAME">new</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">256</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">new</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">IDT table</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int internal_handler</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int idx</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">IDT:install_internal_entry</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">int entry_sz</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_INTRINSIC">@sizeof(IDTEntry)@</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">ptr target</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">table</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">idt_address</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">ptr</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">offset</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">entry_sz</span><span class="orth-T_BINARY_OPERATOR">*</span><span class="orth-T_NAME">idx</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">target</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">IDTEntry</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">set</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">internal_handler</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><br/><span class="orth-T_TYPEDECL_END">endtype</span><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">IRQRegs</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_PACKED">packed</span><br/><span class="orth-T_TYPEDECL_END">endtype</span><br/><br/><span class="orth-T_VAR_DECL">IDT idt</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">setup_irq</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">idt</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">IDT</span><span class="orth-T_DOUBLECOLON">::</span><span class="orth-T_NAME">create</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_CLOSE">)</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">print</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot;IDT@&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">dumphexi</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">idt</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">idt_address</span><span class="orth-T_PAREN_CLOSE">)</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">InternalIDTHandlerLookupTable ihtbl</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">__kget_internal_irq_table</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">InternalIDTHandlerLookupTable</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">int idx</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_INTEGER_LITERAL">0</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHILE_START">while</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">idx</span><span class="orth-T_BINARY_OPERATOR">&lt;</span><span class="orth-T_NAME">ihtbl</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">count</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">idt</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">install_internal_entry</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">ihtbl</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">get</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">idx</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">idx</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">idx</span><span class="orth-T_AUGASSIGN">+=</span><span class="orth-T_INTEGER_LITERAL">1</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">print</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot;!&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">idt</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">handlers</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">set</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x00</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">irq_zerodivision_handler</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">IRQHandler</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">idt</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">handlers</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">set</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x08</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">irq_doublefault_handler</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">IRQHandler</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">idt</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">handlers</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">set</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x0D</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">irq_protectionfault_handler</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">IRQHandler</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">idt</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">handlers</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">set</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x0E</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">irq_pagefault_handler</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">IRQHandler</span><span class="orth-T_PAREN_CLOSE">)</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">idt</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">handlers</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">set</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x20</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">irq_timer_handler</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">IRQHandler</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">idt</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">handlers</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">set</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x21</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">irq_keyboard_handler</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">IRQHandler</span><span class="orth-T_PAREN_CLOSE">)</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_LINE_COMMENT">#Mask interrupts we don&#x27;t have handlers for</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">setup_kbd</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">setup_pit</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_CLOSE">)</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">print</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot;.&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">__klidt</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">idt</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">ptr</span><span class="orth-T_PAREN_CLOSE">)</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">print</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot;.&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">start_irqs</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kterm</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">print</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot; KBD, PIC started. &quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">read_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x60</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">setup_kbd</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x20</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0x11</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0xA0</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0x11</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x21</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0x20</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0xA1</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0x28</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x21</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0x00</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0xA1</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0x00</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x21</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0x01</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0xA1</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0x01</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x21</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0xff</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0xA1</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0xff</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">setup_pit</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x43</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0x36</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_LINE_COMMENT">#Square wave mode</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x40</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_LINE_COMMENT">#65536 ticks/sec, 54.9 ms</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x40</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_LINE_COMMENT">#65536 ticks/sec, 54.9 ms</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">KeyboardEvent</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">int scancode</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">bool state</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">int scancode</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">bool state</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">KeyboardEvent::new</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">KeyboardEvent</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">KeyboardEvent new</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">malloc</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTRINSIC">@sizeof(KeyboardEvent)@</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">KeyboardEvent</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">scancode</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">scancode</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">state</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">state</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">new</span><br/><span class="orth-T_TYPEDECL_END">endtype</span><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">KeyboardConsumerCallback</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_ALIAS">a</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_FUNCTIONPOINTER">function-&gt;void</span><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">KeyboardState</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">ptr button_state_map</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_LINE_COMMENT">#bitmap of states (0=up, 1=down) for buttons (based on scancode)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">KeyboardConsumerCallback handler</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">KeyboardState::new</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">KeyboardState</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">KeyboardState new</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">malloc</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTRINSIC">@sizeof(KeyboardState)@</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">KeyboardState</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">button_state_map</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">malloc</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">128</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">memset</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">button_state_map</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">128</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">byte</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">handler</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">KeyboardConsumerCallback</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">new</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">KeyboardState s</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">uint scancode</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">KeyboardState:getkey</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">bool</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_IF_START">if</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">scancode</span><span class="orth-T_BINARY_OPERATOR">&gt;</span><span class="orth-T_INTEGER_LITERAL">127</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">ikpanici</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot;Internal Error - Invalid Scancode in KeyboardState:getkey&quot;</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">scancode</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">s</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">button_state_map</span><span class="orth-T_LIST_START">[</span><span class="orth-T_NAME">scancode</span><span class="orth-T_LIST_STOP">]</span><span class="orth-T_BINARY_OPERATOR">!=</span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">byte</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">KeyboardState s</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">uint scancode</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">bool state</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">KeyboardState:setkey</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_IF_START">if</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">scancode</span><span class="orth-T_BINARY_OPERATOR">&gt;</span><span class="orth-T_INTEGER_LITERAL">127</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">ikpanici</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_STRING_LITERAL">&quot;Internal Error - Invalid Scancode in KeyboardState:setkey&quot;</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">scancode</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">s</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">button_state_map</span><span class="orth-T_LIST_START">[</span><span class="orth-T_NAME">scancode</span><span class="orth-T_LIST_STOP">]</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">state</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">byte</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_IF_START">if</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">s</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">handler</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">int</span><span class="orth-T_BINARY_OPERATOR">!=</span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">s</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">handler</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">scancode</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">state</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">KeyboardState s</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">KeyboardConsumerCallback handler</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">KeyboardState:set_handler</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">s</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">handler</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">handler</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><br/><span class="orth-T_TYPEDECL_END">endtype</span><br/><br/><span class="orth-T_VAR_DECL">KeyboardState system_kbdstate</span><br/><span class="orth-T_VAR_DECL">long pic_ticks</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">start_irqs</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">system_kbdstate</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">KeyboardState</span><span class="orth-T_DOUBLECOLON">::</span><span class="orth-T_NAME">new</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">pic_ticks</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">long</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x21</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0b11111100</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_LINE_COMMENT">#                         ^^- Enable IRQ0 (0x20 after translation) for PIT</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_LINE_COMMENT">#                         |- Enable IRQ1 (0x21 after translation) for keyboard</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">int cr2</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int exception_id</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int errorcode</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">kirq_callback</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">IRQHandler h</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">idt</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">handlers</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">get</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">exception_id</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_IF_START">if</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">h</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">ptr</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">int</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_BINARY_OPERATOR">==</span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kpanic</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">errorcode</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">exception_id</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_STRING_LITERAL">&quot;No handler for IRQ&quot;</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_STRING_LITERAL">&quot;A unregistered IRQ was fired (unhandled IRQ)&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">h</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">ptr</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">IRQRegs</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">errorcode</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">cr2</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">write_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x20</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0x20</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">IRQRegs regs</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int errorcode</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int cr2</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">irq_keyboard_handler</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">int status</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">read_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x64</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_IF_START">if</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">status</span><span class="orth-T_BINARY_OPERATOR">&amp;</span><span class="orth-T_INTEGER_LITERAL">1</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BINARY_OPERATOR">&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">int value</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">read_port</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0x60</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">int keycode</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">value</span><span class="orth-T_BINARY_OPERATOR">&amp;</span><span class="orth-T_INTEGER_LITERAL">0b01111111</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">system_kbdstate</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">setkey</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">keycode</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">value</span><span class="orth-T_BINARY_OPERATOR">&amp;</span><span class="orth-T_INTEGER_LITERAL">0b10000000</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_BINARY_OPERATOR">==</span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">IRQRegs regs</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int errorcode</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int cr2</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">irq_pagefault_handler</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kpanic</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">errorcode</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">cr2</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_STRING_LITERAL">&quot;Unrecoverable Page Fault Error - INT 0x0E - #PF&quot;</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_STRING_LITERAL">&quot;???&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">IRQRegs regs</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int errorcode</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int cr2</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">irq_protectionfault_handler</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kpanic</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">errorcode</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">cr2</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_STRING_LITERAL">&quot;Unrecoverable Page Fault Error - INT 0x0D - #GPF&quot;</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_STRING_LITERAL">&quot;???&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">IRQRegs regs</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int errorcode</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int cr2</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">irq_doublefault_handler</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kpanic</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">errorcode</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">cr2</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_STRING_LITERAL">&quot;Unrecoverable Double Fault Error - INT 0x08 - #DF&quot;</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_STRING_LITERAL">&quot;???&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">IRQRegs regs</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int errorcode</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int cr2</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">irq_zerodivision_handler</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kpanic</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">errorcode</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">cr2</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_STRING_LITERAL">&quot;Unrecoverable Zero Division Error - INT 0x00 - #DBZ&quot;</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_STRING_LITERAL">&quot;Why would you do that?&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">IRQRegs regs</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int errorcode</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int cr2</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">irq_timer_handler</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">pic_ticks</span><span class="orth-T_AUGASSIGN">+=</span><span class="orth-T_INTEGER_LITERAL">1</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">long</span><br/><span class="orth-T_RETURN">return</span><br/><span class="orth-T_WHITESPACE"> </span>

		</pre>
	</body>
</html>