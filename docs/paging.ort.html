<html>
	<head>
		<title>../os/kernel/paging.ort</title>
		<link rel="stylesheet" type="text/css" href="syntax.css">
	</head>
	<body>
		<pre>

<span class="orth-T_INTRINSIC">@declare_func(&quot;__kget_pagedir_addr&quot;, &quot;ptr&quot;, &quot;()&quot;)@</span><br/><span class="orth-T_INTRINSIC">@declare_func(&quot;__kreload_paging&quot;, &quot;void&quot;, &quot;()&quot;)@</span><br/><br/><span class="orth-T_IMPORT">import mm</span><br/><span class="orth-T_IMPORT">import panic</span><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">PageEntry</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_PACKED">packed</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">int entry</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">PageEntry e</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int address</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">bool big</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">PageEntry:set</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_IF_START">if</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">address</span><span class="orth-T_BINARY_OPERATOR">!=</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">address</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BINARY_OPERATOR">&amp;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">0b11111111111111111111000000000000</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">kpanic</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">big</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">int</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">address</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_STRING_LITERAL">&quot;Internal PDE Error&quot;</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_STRING_LITERAL">&quot;Address not 4KiB aligned&quot;</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">e</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">entry</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">address</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">e</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">entry</span><span class="orth-T_AUGASSIGN">+=</span><span class="orth-T_INTEGER_LITERAL">0b00000000000000000000000000000011</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_LINE_COMMENT">#Present, read/writable</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_IF_START">if</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">big</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_BLOCK_DO">do</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">e</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">entry</span><span class="orth-T_AUGASSIGN">+=</span><span class="orth-T_INTEGER_LITERAL">0b00000000000000000000000010000000</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_LINE_COMMENT">#Set 4MiB granularity flag</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_BLOCK_DONE">done</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">PageEntry e</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">PageEntry:set_nonpresent</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">e</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">entry</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_INTEGER_LITERAL">0</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><br/><span class="orth-T_TYPEDECL_END">endtype</span><br/><br/><span class="orth-T_TYPEDECL">type</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_NAME">PageManager</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_TYPEDECL_IS">is</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">ptr pagedirectory</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">PageManager::new</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">PageManager</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_VAR_DECL">PageManager new</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">malloc</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTRINSIC">@sizeof(PageManager)@</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">PageManager</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">new</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">pagedirectory</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">__kget_pagedir_addr</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">new</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">PageManager m</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int idx</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">PageManager:get_pde_slot_idx</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">PageEntry</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">m</span><span class="orth-T_DOT">.</span><span class="orth-T_NAME">pagedirectory</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">offset</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">idx</span><span class="orth-T_BINARY_OPERATOR">*</span><span class="orth-T_INTRINSIC">@sizeof(PageEntry)@</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">PageEntry</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">int addr</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">PageManager::get_slot_for_addr</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">int</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">addr</span><span class="orth-T_BINARY_OPERATOR">&gt;&gt;</span><span class="orth-T_INTEGER_LITERAL">22</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_ELEMENT">PageManager m</span><span class="orth-T_ARGLIST_SEPERATOR">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_ARGLIST_ELEMENT">int addr</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">PageManager:get_pde_slot_addr</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">PageEntry</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_RETURN">return</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_NAME">m</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">get_pde_slot_idx</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">PageManager</span><span class="orth-T_DOUBLECOLON">::</span><span class="orth-T_NAME">get_slot_for_addr</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">addr</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_TYPEDECL_END">endtype</span><br/><br/><span class="orth-T_VAR_DECL">PageManager page_manager</span><br/><br/><span class="orth-T_FUNCTIONDECL">function</span><span class="orth-T_ARGLIST_START">(</span><span class="orth-T_ARGLIST_END">)</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_NAME">init_pm</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURNS">-&gt;</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_RETURN_TYPE">void</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_FUNCTIONDECL_DOES">does</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">page_manager</span><span class="orth-T_ASSIGNMENT">=</span><span class="orth-T_NAME">PageManager</span><span class="orth-T_DOUBLECOLON">::</span><span class="orth-T_NAME">new</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_LINE_COMMENT">#The page (768) for the kernel should be set up already (if it&#x27;s not we wouldn&#x27;t be running :P)</span><br/><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">page_manager</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">get_pde_slot_addr</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_NAME">base_vma</span><span class="orth-T_PAREN_CLOSE">)</span><span class="orth-T_COLON">:</span><span class="orth-T_NAME">set</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_INTEGER_LITERAL">0</span><span class="orth-T_COMMA">,</span><span class="orth-T_WHITESPACE"> </span><span class="orth-T_INTEGER_LITERAL">1</span><span class="orth-T_CAST">|</span><span class="orth-T_NAME">bool</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_WHITESPACE">	</span><span class="orth-T_NAME">__kreload_paging</span><span class="orth-T_PAREN_OPEN">(</span><span class="orth-T_PAREN_CLOSE">)</span><br/><span class="orth-T_RETURN">return</span><br/><span class="orth-T_WHITESPACE"> </span>

		</pre>
	</body>
</html>